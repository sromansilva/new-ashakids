<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/terapeutaLayout :: Head}"></head>

<body data-role="TERAPEUTA">

  <!-- Sidebar -->

  <div th:replace="~{fragments/terapeutaLayout :: menuToggle}"></div>

  <nav th:replace="~{fragments/terapeutaLayout :: sidebarTerapeuta}"></nav>

  <div th:replace="~{fragments/terapeutaLayout :: overlay}"></div>


  <!-- Ãrea de contenido -->
  <main class="content-area">

    <h2 class="fw-bold mb-4">Â¡Hola, <span th:text="${terapeuta.nombre}"></span>! ğŸ‘‹</h2>

    <div class="p-5 mb-4 rounded-4 d-flex align-items-center justify-content-between position-relative overflow-hidden"
      style="background: linear-gradient(90deg, #7b1fa2 0%, #1976d2 60%, #42a5f5 100%); color: white; min-height: 240px; max-width: 1500px; margin: 0 auto 2rem auto; box-shadow: 0 8px 32px rgba(123,31,162,0.12);">
      <!-- Detalle decorativo SVG -->
      <svg style="position:absolute;right:0;bottom:0;z-index:0;opacity:0.15;" width="300" height="180"
        viewBox="0 0 300 180">
        <ellipse cx="150" cy="90" rx="150" ry="90" fill="#fff" />
      </svg>
      <div class="flex-grow-1 position-relative" style="z-index:1;">
        <h1 class="fw-bold display-4 mb-3 fs-1" style="letter-spacing:1px;">Organiza tus citas y recursos en Ashakids</h1>
        <p class="fs-4 mb-4">Planifica tus sesiones, accede a tus pacientes y mantÃ©n todo bajo control desde tu panel de
          terapeuta.</p>
        <a href="/terapeuta/agenda" class="btn fw-bold px-4 py-2 fs-5"
          style="background:#ffb300;color:#fff;box-shadow:0 2px 8px #ffb30055;">Ver agenda</a>
      </div>
      <div class="d-none d-md-block ms-4 flex-shrink-0 position-relative" style="z-index:1;">
        <img src="/img/conoceMas.png" alt="Banner decorativo"
          style="max-width: 240px; max-height: 180px; border-radius: 2rem; box-shadow:0 4px 24px #7b1fa255;"
          th:src="@{/img/conoceMas.png}">
      </div>
    </div>

    <!-- Accesos rÃ¡pidos en contenedor mÃ¡s pequeÃ±o y colorido -->
    <div class="bg-white rounded-4 shadow-lg p-4 mb-4 mx-auto" style="max-width: 1000px;">
      <div class="row g-3 justify-content-center align-items-center">
        <div class="col-6 col-md-2">
          <div class="card shadow-sm rounded-3 p-3 h-100 text-center border-0 quick-access-card"
            style="background: linear-gradient(135deg,#42a5f5 60%,#bbdefb 100%); border-bottom: 6px solid #1976d2; transition: transform 0.2s, box-shadow 0.2s;">
            <div class="display-4 mb-1">ğŸ“…</div>
            <a href="/terapeuta/agenda" class="text-decoration-none text-dark fw-bold small">Agenda</a>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="card shadow-sm rounded-3 p-3 h-100 text-center border-0 quick-access-card"
            style="background: linear-gradient(135deg,#fff176 60%,#fffde7 100%); border-bottom: 6px solid #ffb300; transition: transform 0.2s, box-shadow 0.2s;">
            <div class="display-4 mb-1">âœ‰ï¸</div>
            <a href="/terapeuta/mensajes" class="text-decoration-none text-dark fw-bold small">Mensajes</a>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="card shadow-sm rounded-3 p-3 h-100 text-center border-0 quick-access-card"
            style="background: linear-gradient(135deg,#81c784 60%,#e8f5e9 100%); border-bottom: 6px solid #388e3c; transition: transform 0.2s, box-shadow 0.2s;">
            <div class="display-4 mb-1">ğŸ§</div>
            <a href="/terapeuta/pacientes" class="text-decoration-none text-dark fw-bold small">Pacientes</a>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="card shadow-sm rounded-3 p-3 h-100 text-center border-0 quick-access-card"
            style="background: linear-gradient(135deg,#ffb74d 60%,#fff3e0 100%); border-bottom: 6px solid #f57c00; transition: transform 0.2s, box-shadow 0.2s;">
            <div class="display-4 mb-1">ğŸ“‹</div>
            <a href="/terapeuta/reportes" class="text-decoration-none text-dark fw-bold small">Reportes</a>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="card shadow-sm rounded-3 p-3 h-100 text-center border-0 quick-access-card"
            style="background: linear-gradient(135deg,#f06292 60%,#fce4ec 100%); border-bottom: 6px solid #c2185b; transition: transform 0.2s, box-shadow 0.2s;">
            <div class="display-4 mb-1">ğŸ“š</div>
            <a href="/terapeuta/recursos" class="text-decoration-none text-dark fw-bold small">Recursos</a>
          </div>
        </div>
      </div>
    </div>

    <style>
          .quick-access-card:hover {
      transform: translateY(-6px) scale(1.04);
      box-shadow: 0 8px 32px rgba(33,150,243,0.18), 0 1.5px 6px rgba(33,150,243,0.10);
      z-index: 2;
    }
    
    /* Estilos para manejar links largos */
    .link-container {
      word-break: break-all;
      overflow-wrap: break-word;
      max-width: 100%;
    }
    
    .link-text {
      font-size: 0.8rem;
      color: #666;
      word-break: break-all;
      overflow-wrap: break-word;
      max-width: 100%;
    }
    </style>

    <!-- PrÃ³ximas citas en tarjeta alineada al banner, con borde colorido -->
    <div class="bg-white rounded-4 shadow-lg p-4 mb-4 mx-auto" style="max-width: 1500px;">
      <h3 class="fw-bold mb-4" style="color:#1976d2;">ğŸ“… PrÃ³ximas citas</h3>
      <div th:if="${#lists.isEmpty(citas)}">
        <div class="text-center py-5">
          <div class="mb-3">
            <span class="display-3" style="color:#1976d2;">ğŸ˜Œ</span>
          </div>
          <h4 class="fw-bold mb-2" style="color:#1976d2;">Â¡No tienes citas programadas!</h4>
          <p class="text-muted mb-0">Cuando tengas citas agendadas, aparecerÃ¡n aquÃ­ para que puedas gestionarlas
            fÃ¡cilmente.</p>
        </div>
      </div>
      <div th:if="${!#lists.isEmpty(citas)}">
        <div class="row g-3">
          <div th:each="cita : ${citas}" class="col-12 col-md-6 col-lg-4">
            <div class="card h-100 border-0 shadow-sm rounded-3"
              style="background: linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%); border-left: 4px solid #1976d2;">
              <div class="card-body p-3">
                <!-- TÃ­tulo de la cita (tema) -->
                <h6 class="fw-bold mb-2 text-primary" th:text="${cita.tema != null ? cita.tema : 'Cita de Terapia'}">Cita de Terapia</h6>
                
                <!-- Fecha y hora -->
                <p class="mb-1 small"><strong>ğŸ“… Fecha:</strong> <span th:text="${cita.fecha != null ? #temporals.format(cita.fecha, 'EEEE, d MMMM yyyy') : 'Sin fecha'}">Fecha</span></p>
                <p class="mb-1 small"><strong>ğŸ• Hora:</strong> <span th:text="${cita.hora != null ? cita.hora : 'Sin hora'}">Hora</span></p>
                
                <!-- InformaciÃ³n del paciente y tutor -->
                <p class="mb-1 small"><strong>ğŸ‘¶ NiÃ±o:</strong> <span th:text="${cita.nino != null && cita.nino.nombre != null ? cita.nino.nombre : 'Sin asignar'}">Nombre NiÃ±o</span></p>
                <p class="mb-1 small"><strong>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Tutor:</strong> <span th:text="${cita.retroalimentacion_padre != null ? cita.retroalimentacion_padre : 'No especificado'}">Nombre Tutor</span></p>
                
                <!-- Modalidad -->
                <p class="mb-1 small"><strong>ğŸ¯ Modalidad:</strong> 
                  <span th:if="${cita.modalidad == 'Virtual'}" class="badge bg-info">Virtual</span>
                  <span th:if="${cita.modalidad == 'Presencial'}" class="badge bg-warning">Presencial</span>
                  <span th:if="${cita.modalidad == null}" class="text-muted">Sin especificar</span>
                </p>
                
                <!-- Estado -->
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="badge bg-primary"
                    th:text="${cita.estado != null ? cita.estado : 'Sin estado'}">Estado</span>
                </div>
                
                <!-- Botones segÃºn modalidad -->
                <div class="d-flex gap-2 mt-3">
                  <!-- BotÃ³n Zoom solo para citas virtuales -->
                  <button th:if="${cita.modalidad == 'Virtual' && cita.enlace_o_direccion != null}" 
                          class="btn btn-success btn-sm flex-fill" 
                          style="background: linear-gradient(135deg,#4caf50 0%,#66bb6a 100%); border: none; color: white; font-size: 0.8rem;"
                          th:data-zoom-link="${cita.enlace_o_direccion}"
                          onclick="window.open(this.getAttribute('data-zoom-link'), '_blank')">
                    <i class="fas fa-video me-1"></i> Unirse al Zoom
                  </button>
                  
                  <!-- Aviso para citas presenciales -->
                  <div th:if="${cita.modalidad == 'Presencial'}" 
                       class="btn btn-warning btn-sm flex-fill" 
                       style="background: linear-gradient(135deg,#ff9800 0%,#ffb74d 100%); border: none; color: white; font-size: 0.8rem; cursor: default;">
                    <i class="fas fa-building me-1"></i> Cita en Sede
                  </div>
                  
                  <!-- BotÃ³n cancelar -->
                  <button class="btn btn-danger btn-sm flex-fill cancelar-cita-btn" 
                          style="background: linear-gradient(135deg,#f44336 0%,#ef5350 100%); border: none; color: white; font-size: 0.8rem;"
                          th:data-cita-id="${cita.id_cita}">
                    <i class="fas fa-times me-1"></i> Cancelar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div th:replace="~{fragments/terapeutaLayout :: terapeuta-scripts}"></div>
 
  <!-- Script para cancelar citas -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Manejar clics en botones de cancelar cita
      document.addEventListener('click', function(e) {
        if (e.target.closest('.cancelar-cita-btn')) {
          const button = e.target.closest('.cancelar-cita-btn');
          const citaId = button.getAttribute('data-cita-id');
          
          if (confirm('Â¿EstÃ¡s seguro de que quieres cancelar esta cita? Esta acciÃ³n no se puede deshacer.')) {
            cancelarCita(citaId, button);
          }
        }
      });
      
      async function cancelarCita(citaId, button) {
        try {
          const response = await fetch(`http://localhost:3000/cancelar-cita/${citaId}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          const result = await response.json();
          
          if (response.ok) {
            // Mostrar mensaje de Ã©xito
            alert('Cita cancelada exitosamente');
            
            // Remover la tarjeta de la cita del DOM
            const card = button.closest('.col-12');
            if (card) {
              card.remove();
            }
            
            // Si no quedan citas, recargar la pÃ¡gina
            const remainingCards = document.querySelectorAll('.col-12');
            if (remainingCards.length === 0) {
              location.reload();
            }
          } else {
            alert('Error al cancelar la cita: ' + (result.error || 'Error desconocido'));
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error al cancelar la cita. Verifica que el servidor estÃ© ejecutÃ¡ndose.');
        }
      }
    });
  </script>
</body>

</html>